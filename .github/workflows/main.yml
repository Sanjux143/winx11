name: Fix Winlator Build

on:
  workflow_dispatch: # Button se run karne ke liye
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Code Checkout (Recursive zaroori hai saare modules ke liye)
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 2. Java 17 Setup
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # 3. Android NDK Setup (Winlator ke liye sabse zaroori)
    # Winlator usually NDK version 25 ya 26 use karta hai
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        add-to-path: true

    # 4. Local Properties set karna (Taaki Gradle ko NDK mil sake)
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties

    # 5. Gradle Permission
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 6. Build Command (Stacktrace add kiya hai taaki error dikhe)
    # Hum pehle clean karenge fir build karenge
    - name: Build Debug APK
      run: ./gradlew clean assembleDebug --stacktrace --info

    # 7. APK Upload
    - name: Upload APK
      if: success() # Sirf tab upload karega agar build pass hua
      uses: actions/upload-artifact@v4
      with:
        name: Winlator-Fixed-APK
        path: app/build/outputs/apk/debug/*.apk
