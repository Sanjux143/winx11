name: Build WinX11 APK (No Wrapper)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout Code (Submodules FALSE)
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    # 2. DEBUG: List all files (Taaki humein file structure dikhe)
    - name: List Files (Debug)
      run: ls -R

    # 3. FIX: Missing Submodule URL
    - name: Fix Broken Submodules
      run: |
        git config --file .gitmodules --add submodule."app/src/main/cpp/OpenXR-SDK".path "app/src/main/cpp/OpenXR-SDK"
        git config --file .gitmodules --add submodule."app/src/main/cpp/OpenXR-SDK".url "https://github.com/KhronosGroup/OpenXR-SDK.git"
        git submodule sync
        git submodule update --init --recursive || echo "Ignore submodule errors"

    # 4. Java 17 Setup
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 5. Android NDK Setup
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        add-to-path: true

    # 6. Local Properties (SDK/NDK link)
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties

    # 7. Build Command (CHANGED: using 'gradle' instead of './gradlew')
    - name: Build Debug APK
      run: gradle clean assembleDebug --stacktrace --no-daemon

    # 8. Upload APK
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: WinX11-APK
        path: app/build/outputs/apk/debug/*.apk
