name: Build WinX11 APK (Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout Code (Submodules FALSE rakha hai taaki crash na ho)
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false  # Important: Hum niche manually fix karenge
        fetch-depth: 0

    # 2. FIX: Missing Submodule URL ko manually add karna
    - name: Fix Broken Submodules
      run: |
        # OpenXR-SDK ka URL missing hai, hum usse manually config me daal rahe hain
        git config --file .gitmodules --add submodule."app/src/main/cpp/OpenXR-SDK".path "app/src/main/cpp/OpenXR-SDK"
        git config --file .gitmodules --add submodule."app/src/main/cpp/OpenXR-SDK".url "https://github.com/KhronosGroup/OpenXR-SDK.git"
        
        # Ab sync aur update karenge
        git submodule sync
        git submodule update --init --recursive || echo "Agar koi error aaya toh ignore karo"

    # 3. Java 17 Setup
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # 4. Android NDK Setup (Winlator/WinX11 ke liye zaroori)
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        add-to-path: true

    # 5. Local Properties (NDK Path set karna)
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties

    # 6. Gradle Permission
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 7. Build Command
    - name: Build Debug APK
      run: ./gradlew clean assembleDebug --stacktrace

    # 8. Upload APK
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: WinX11-APK
        path: app/build/outputs/apk/debug/*.apk
